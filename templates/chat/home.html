{% extends 'base.html' %}
{% block title %}Chat{% endblock title %}
{% block body %}
{% csrf_token %}

<div style="margin: 5px; width: 97%; height: 81vh;" class="slate-container">


    <div class="flex-row" style="height: 97%;">
        <div id="chats-list">
            {% for chat in CHATS %}
            <div class="chat-head" id="chat-{{chat.id}}" onclick="setActiveChat({{chat.id}});">
                {{chat}}
            </div>
            {% endfor %}

        </div>


        <div id="active-chat">
            <div id="active-chat-header">

            </div>

            <div id="messages" class="flex-column">




            </div>


        </div>
    </div>
    <style>
        #messages {
            overflow-y: auto;
        }

        .message-author img {
            width: 20px;
            border-radius: 50%;
        }

        .inner_message-author {
            right: 0%;
        }

        .outer_message-author {
            left: 0%;
        }

        .message-author {
            margin: 7px;
            padding: 5px;
            position: absolute;
        }

        .message-sent-time {
            position: absolute;
            font-size: 11px;
            bottom: 25%;
            right: 50%;
            visibility: hidden;
            color: #aeaeae;
            font-weight: 700;
        }

        .message-wrapper {
            width: 100%;
            position: relative;
        }


        .message:hover .message-sent-time {
            visibility: visible;
        }

        .message {
            padding: 5px;
            border-radius: 5px;
            width: fit-content;
            max-width: 40%;
            color: black;
            margin: 7px;
        }

        .inner_message {
            float: right;
            background-color: #202020;
            margin-right: 40px;
        }

        .outer_message {
            margin-left: 40px;
            float: left;
            background-color: var(--ORANGEISH);

        }
    </style>

    <script>
        let csrftoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;

        function setActiveChat(chat_id) {
            try {
                document.getElementsByClassName('active_chat_head')[0].classList.remove('active_chat_head');
            } catch { };
            document.getElementById('chat-' + chat_id).classList.add('active_chat_head');

            fetchMessages(chat_id);
        }


        function fetchMessages(chat_id) {

            let form = new FormData(); // Add Data to be sent to this 'form'

            form.set('chat_id', chat_id)

            fetch(`fetch_messages`,
                {
                    method: 'POST',
                    body: form,
                    headers: {
                        'Accept': 'multipart/form-data, application/json, text/plain, */*',
                        "X-CSRFToken": csrftoken
                    },
                })
                .then(response => response.json())
                .then(data => {
                    // console.log(data);
                    if (data.SUCCESS) {
                        pasteMessages(data.MESSAGES);
                    }

                });
        }

        function pasteMessages(MESSAGES) {

            let chatHTML = ``;

            for (let message in MESSAGES) {
                let msg = MESSAGES[message];
                console.log(msg);

                // Vars
                let oorin = 'outer';

                if (msg.AUTHOR == '{{user}}') {
                    oorin = 'inner';
                }

                let htmlsnippet = `
                <div class="message-wrapper">
                    <div class="message-author ${oorin}_message-author ">
                        <img src="http://127.0.0.1:8000/username_profilepic-${msg.AUTHOR}" alt="">
                    </div>
                    <div class="message ${oorin}_message" id="${msg.ID}">
                        <div class="message-text">
                            ${msg.TEXT}
                        </div>

                        <div class="message-sent-time" id="message-sent-time-${msg.ID}">
                            ${msg.TIME_SENT}
                        </div>

                    </div>
                </div>
                `;

                chatHTML += htmlsnippet;


            }

            document.getElementById('messages').innerHTML = chatHTML;

            let active_chat = document.getElementById("active-chat");
            active_chat.scrollTop = active_chat.scrollHeight;



        }

    </script>



</div>
{% endblock body %}